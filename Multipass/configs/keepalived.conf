{% set host_index = groups['all'].index(inventory_hostname) %}
{% set keepalived_priority = 255 - (10 * host_index) %}

vrrp_track_process track_haproxy {
    process haproxy
    delay 1
}

vrrp_instance haproxy {
    state BACKUP
    virtual_router_id {{ keepalived_router_id }}
    priority {{ keepalived_priority }}
    interface {{ keepalived_interface }}
    advert_int 5
    authentication {
        auth_type PASS
        auth_pass {{ keepalived_auth_pass }}
    }
    virtual_ipaddress {
        {{ haproxy_vip }}/24
    }
    track_process {
        track_haproxy
    }
}